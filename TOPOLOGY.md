# LACCHAIN TOPOLOGY AND ARCHITECTURE

The purpose of this documentation is to provide an overview of the LACCHAIN Besu Network's topology architecture, communication protocols and security.

## Topology

The nodes of LACChain DLT public-permissioned networks can be classified into two groups, according to their participation in the maintenance of the network. In each of these two groups there are also two different types of nodes, according to the specific role of the node in the network. 

In the following image we can see the topology and connections between the different types of nodes.

![LACCHAIN Topology](/docs/images/topology.png)

### Core nodes

Core nodes play an essential role in the correct functioning of the network. The network can't work without them. Core nodes are classified into validator and boot nodes.

* **Validator nodes**

    Validator nodes are those that participate of the consensus protocol, hashing transactions and proposing new blocks. Validator nodes are only connected to each other and to boot nodes.

* **Boot nodes**

    Boot nodes are those that act as a liaison between validator and satellite nodes, which implies that (i) .they listen to the writer nodes and pass the information about the transactions generated by them to the validator nodes, and (ii) they update the satellite nodes about the new blocks generated by the validator nodes. They are also responsible for setting up new nodes by updating them with the latest version of the blockchain and other relevant information such as whitelists and blacklists.

    Boot nodes are connected to all the nodes in the network.

### Satellite nodes

Satellite nodes do not play an essential role in the correct functioning of the network. The network works without them. Satellite nodes are classified into writer and observer nodes.

* **Writer nodes**

    Writer nodes are those that generate the transactions to be recorded in the network. They communicate the transactions to the boot nodes, that pass them along to the validator nodes. They can also create private channels between themselves for private communication using the [Orion](https://github.com/PegaSysEng/orion) private transaction manager.

    Writer nodes are connected to boot nodes and to other writer nodes.

* **Observer nodes**

    Observer nodes are those that can only read the blockchain.

    Observer nodes only connected to boot nodes.

    **Note: Observer nodes haven’t been enabled yet in the LACChain Besu Network.**

## Architecture

LACChain Networks are distributed ledgers aimed at serving as a trusted and immutable public-permissioned blockchains to be used by any entity in Latin America and the Caribbean to deploy use applications with social impact. Therefore, LACChain Networks are peer-to-peer networks.

For the purpose of the LACChain Global Alliance, peer-to-peer(P2P) architectures present many advantages against client-server architectures:

<br>

|Client Server     |Peer-to-Peer|
|-----------|-----------|
|1. Server is the central entity and only<br> provider of service and content.<br>2. Network managed by the server<br>3. Server as the higher performance<br> system<br>4. Clients as the lower performance system<br><br>**Example: WWW** |1. Resources are shared between the peers<br> 2. Resources can be accessed directly from<br> other peers<br> 3. Peer is provider and requestor<br> 4. Any peer can be removed without loss of <br>overall functionality<br> 5. No central entities<br><br> **Example: Ethereum, LACChain**|

In peer-to-peer systems each peer behaves both as a server and as a client. Each peer or client can send and receive data directly from any other peer or client. In blockchain jargon peers are generally called nodes. Each node can request data from it’s own databases, and it can also read from another node’s database. 

LACChain Besu Network is deployed using [Hyperledger Besu](https://www.hyperledger.org/projects/besu "Hyperledger Besu"), which is a Ethereum enterprise client. In LACChain Besu Network all nodes can request information from other node, about the network’s current state (smart contracts, account balance, latest blocks, etc.).

Additionally, each node maintains both a synchronized copy of the full ledger and a repository of the smart contracts that have been deployed in the network. Nodes rely on validator nodes to validate transactions and generate now blocks through the application
of the consensus protocol. LACChain Besu Network operates with [IBFT2.0 consensus protocol](https://www.researchgate.net/publication/335990137_IBFT_20_A_Safe_and_Live_Variation_of_the_IBFT_Blockchain_Consensus_Protocol_for_Eventually_Synchronous_Networks).

As LACChain Besu Network is based on Ethereum infraestructure, the architecture of the network has two stacks. A Discovery Stack to discover existing nodes in the network and Connection Stack to send messages or communicate with other nodes in the network. 

![LACCHAIN Stacks](/docs/images/stacks.png)

### Node Discovery

For a P2P network work properly, there must be a good implementation of node discovery, that allows a node to discover other nodes that are part of the network. In LACChain Networks, as detailed previously in Section Topology, nodes can have the category
of validator, boot, writer or observer node.

The discover protocol implemented in LACChain’s Besu Network to build the peer to peer network is based on [Kademlia](https://pdos.csail.mit.edu/~petar/papers/maymounkov-kademlia-lncs.pdf "Kademlia paper").

Kademlia is a well-defined distributed hash table recognized as a robust standard and protocol. LACChain Besu Network inherits from Ethereum [the use of the discovery part of the Kademlia protocol](https://github.com/ethereum/wiki/wiki/Kademlia-Peer-Selection "Kademlia in Ethereum").

To begin the discovery process the node needs an identity. Currently, the identity of the node is achieved through an enodeID, wich is then hashed with [SHA3](https://en.bitcoinwiki.org/wiki/SHA-3 "SHA3") into a 256-bit value. For more details, you can go to [node identity](https://github.com/ethereum/devp2p/blob/master/rlpx.md#node-identity "node-identity"). In the future, LACChain nodes will be using Decentralized Identifiers (DIDs) and Verifiable Credentials (VC) for identification and authentication. In order for a node to get an identity in LACChain Besu Network, you can follow the instructions in the [README](https://github.com/lacchain/besu-network).

Once you have deployed your node, got your identity and followed the administrative steps to be permissioned in [LACChain Besu Network](https://github.com/lacchain/besu-network/blob/master/PERMISSIONING_PROCESS.md) you node will start the discovery process.

LACChain uses [**UDP** protocol](https://www.geeksforgeeks.org/user-datagram-protocol-udp/) to exchange information across the P2P network. The steps to achieve the discovery of nodes in the network are the following:

* LIST: When a new node aims to join a network, it needs to be provided with a list of nodes that are already part of that network so it can try to communicate with them. In LACChain Besu Network, the addresses of the boot nodes are hard-coded so the node automatically accesses. The file where you could modify boot nodes is located in **/root/lacchain/orion.conf**.

![configuration of boots nodes](/docs/images/boot_config.png)

* PING: A PING message is sent by the new node expecting a PONG message in return. This pair of messages is used to determine whether a neighboring node is responsive. The new node sends PING messages to all the boot nodes from the list.

* FIND_NEIGHBOURS: As soon as the new node gets PONG messages from responsive boot nodes, it sends a findnode message asking them for a list of 16 nodes of those they are connected to.

* CONNECT: At present, there are no limits for the number of nodes a new node can be connected to. In order to isolate validator nodes from writer and observer nodes so they can provide a better performance to apply the consensus protocol, we run each node in its own instance(Virtual Machine).

![P2P Network](/docs/images/discovery.png)

To summarize, the discovery process to join a node to the lacchain network is as follows:
* Get a enode ID.
* Get the list of boot nodes.
* Bond to boot nodes:
    * Send Ping
    * On Pong do a findNeighbours
* Connect to active nodes

* Table of new node is persisted to minimize bootstrap requirements

### Node Communication

Once discovery is successful, two nodes can start communicating over the LACChain Besu Network. Communication consist of sending and receiving messages between nodes.

For data transfer, LACChain Besu Network uses the [RLPx Protocol](https://github.com/ethereum/devp2p/blob/master/rlpx.md "RLPx"). RLPx enables nodes to transfer encrypted and serialized data through encrypted multiplexed messaging.

This protocol leverages Elliptic Curve Integrated Encryption Scheme (ECIES) to establish secure communications between nodes using public key infrastructure and [elliptic curve cryptography](https://hackernoon.com/what-is-the-math-behind-elliptic-curve-cryptography-f61b25253da3 "elliptic curve").

After the handshake both nodes send to each other which protocols and which versions of these protocols they support: The Ethereum protocol is “eth”, the Ethereum’s Whisper protocol is “shh”, and the Light Ethereum Node Subprotocol is “les”.

The subsequent messages are dependent on the protocol chosen. 

Through this protocol, writer nodes pass transactions they want to register in the blockchain along to boot nodes, boot nodes update writer and observer nodes on the new blocks generated by the validator nodes, and validator nodes agree on the generation of new blocks among themselves and communicate to boot nodes the new blocks generated.

### Transactions

Transactions are the way the off-chain world interacts with the LACChain network. Transactions are used to amend or update the state stored in the LACChain network.

The transaction cycle is:

* An account address sends a signed transaction to a writer node.

* The writer node validates signed transaction to make sure that it was really signed by an authorized account address (every writer node is responsible for whitelisting or blacklisting account addresses, as they are fully responsible for the transactions they introduce in the network).

* The writer node sends the transaction to the boot nodes it is connected to. Once the transaction is broadcast, the writer node also outputs the transaction id which can be used to track the status of the transaction.

* The boot noodes pass the transaction along to the validator nodes.

* Validator nodes receive the transaction and add it to the transaction pool.

![Tx Pool](/docs/images/tx_pool.png)

* Validator nodes apply the [IBFT2.0 consensus protocol](https://www.researchgate.net/publication/335990137_IBFT_20_A_Safe_and_Live_Variation_of_the_IBFT_Blockchain_Consensus_Protocol_for_Eventually_Synchronous_Networks) to validate the transaction and incorporate it into a new block. The number of transactions that can fit into a block depends on LACChain Besu Network block size.

* Validator nodes update their ledger by appending the new block and send the information to the boot nodes.

* Boot nodes pass the information along to writer and observer nodes. Upon receiving the new block, writer and observer nodes execute all the transacciones in the block.

### Permissioning
#TO DO#